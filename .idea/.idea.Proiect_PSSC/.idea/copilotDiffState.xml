<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/Domain.Shipping/Models/IShipmentManifestedEvent.cs">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/Domain.Shipping/Models/IShipmentManifestedEvent.cs" />
              <option name="originalContent" value="namespace Domain.Shipping.Models;&#10;&#10;public interface IShipmentManifestedEvent&#10;{&#10;    Guid OrderId { get; }&#10;    Guid CustomerId { get; }&#10;    ShippingAddress ShippingAddress { get; init; }&#10;    &#10;    // Costul calculat al transportului&#10;    Money ShippingCost { get; }&#10;    &#10;    // Codul AWB generat (rezultatul principal al muncii tale)&#10;    AwbCode Awb { get; }&#10;    &#10;    &#10;    &#10;    // Data și ora la care s-a generat AWB-ul&#10;    DateTime ManifestedAt { get; }&#10;}&#10;&#10;public record ShipmentManifestedEvent(&#10;    Guid OrderId,&#10;    Guid CustomerId,&#10;    ShippingAddress ShippingAddress,&#10;    Money ShippingCost,&#10;    AwbCode Awb,&#10;    DateTime ManifestedAt&#10;) : IShipmentManifestedEvent;&#10;" />
              <option name="updatedContent" value="namespace Domain.Shipping.Models;&#10;&#10;public interface IShipmentManifestedEvent&#10;{&#10;    Guid OrderId { get; }&#10;    Guid CustomerId { get; }&#10;    ShippingAddress ShippingAddress { get; init; }&#10;    &#10;    // Lista de linii ale expedierii (ProductCode + Quantity)&#10;    IReadOnlyCollection&lt;ShipmentLine&gt; Lines { get; }&#10;    &#10;    // Costul calculat al transportului&#10;    Money ShippingCost { get; }&#10;    &#10;    // Codul AWB generat (rezultatul principal al muncii tale)&#10;    AwbCode Awb { get; }&#10;    &#10;    &#10;    &#10;    // Data și ora la care s-a generat AWB-ul&#10;    DateTime ManifestedAt { get; }&#10;}&#10;&#10;public record ShipmentManifestedEvent(&#10;    Guid OrderId,&#10;    Guid CustomerId,&#10;    ShippingAddress ShippingAddress,&#10;    IReadOnlyCollection&lt;ShipmentLine&gt; Lines,&#10;    Money ShippingCost,&#10;    AwbCode Awb,&#10;    DateTime ManifestedAt&#10;) : IShipmentManifestedEvent;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/Shipping.Api/InvoidePainListener.cs">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/Shipping.Api/InvoidePainListener.cs" />
              <option name="originalContent" value="using System.Text.Json;&#10;using Azure.Messaging.ServiceBus;&#10;using Domain.Shipping.Models;&#10;using Domain.Shipping.Repositories;&#10;using Domain.Shipping.Workflows;&#10;using Microsoft.Extensions.Configuration;&#10;using Microsoft.Extensions.DependencyInjection;&#10;using Microsoft.Extensions.Hosting;&#10;using Shipping.Api.Messaging;&#10;&#10;namespace Shipping.Api.BackgroundServices;&#10;&#10;public class InvoicePaidListener : BackgroundService&#10;{&#10;    private readonly ServiceBusProcessor _processor;&#10;    private readonly ServiceBusSender _shippingSender;&#10;    private readonly IServiceProvider _serviceProvider;&#10;&#10;    public InvoicePaidListener(&#10;        ServiceBusClient client,&#10;        IConfiguration config,&#10;        IServiceProvider serviceProvider)&#10;    {&#10;        _serviceProvider = serviceProvider;&#10;&#10;        // 1. CONFIGURARE CONSUMATOR (Input)&#10;        // Ascultăm topicul unde colegul tău trimite mesajele (ex: &quot;sbt-billing-payments&quot;)&#10;        var billingTopic = config[&quot;ServiceBus:BillingTopic&quot;];&#10;        var shippingSubscription = config[&quot;ServiceBus:ShippingSubscription&quot;];&#10;        &#10;        _processor = client.CreateProcessor(billingTopic, shippingSubscription, new ServiceBusProcessorOptions&#10;        {&#10;            // Setări pentru siguranță (să nu proceseze prea multe deodată)&#10;            MaxConcurrentCalls = 1,&#10;            AutoCompleteMessages = false&#10;        });&#10;&#10;        // 2. CONFIGURARE PRODUCĂTOR (Output)&#10;        // Trimitem mesajul final către un topic nou (ex: &quot;sbt-shipping-manifests&quot;)&#10;        var shippingTopic = config[&quot;ServiceBus:ShippingTopic&quot;];&#10;        _shippingSender = client.CreateSender(shippingTopic);&#10;    }&#10;&#10;    protected override Task ExecuteAsync(CancellationToken stoppingToken)&#10;    {&#10;        _processor.ProcessMessageAsync += OnMessageAsync;&#10;        _processor.ProcessErrorAsync += args =&gt;&#10;        {&#10;            Console.WriteLine($&quot;SB ERROR: {args.Exception.GetType().Name} - {args.Exception.Message}&quot;);&#10;            return Task.CompletedTask;&#10;        };&#10;&#10;        return _processor.StartProcessingAsync(stoppingToken);&#10;    }&#10;&#10;    private async Task OnMessageAsync(ProcessMessageEventArgs args)&#10;    {&#10;        // A. Deserializare Mesaj Intrare (InvoicePaidMessage)&#10;        var bodyJson = args.Message.Body.ToString();&#10;        var invoiceMsg = JsonSerializer.Deserialize&lt;InvoicePaidMessage&gt;(bodyJson);&#10;        // SAU varianta Azure SDK: args.Message.Body.ToObjectFromJson&lt;InvoicePaidMessage&gt;();&#10;&#10;        if (invoiceMsg is null)&#10;        {&#10;            await args.DeadLetterMessageAsync(args.Message, &quot;DeserializationFailed&quot;, &quot;Body was null&quot;);&#10;            return;&#10;        }&#10;&#10;        // B. Creare Scope (Pentru servicii Scoped: DB, Workflow)&#10;        using (var scope = _serviceProvider.CreateScope())&#10;        {&#10;            var workflow = scope.ServiceProvider.GetRequiredService&lt;ShippingWorkflow&gt;();&#10;            var repository = scope.ServiceProvider.GetRequiredService&lt;IShipmentRepository&gt;();&#10;&#10;            try&#10;            {&#10;                // 1. Convertim Mesajul în Comandă Internă&#10;                var command = new ProcessShipmentCommand&#10;                {&#10;                    OrderId = invoiceMsg.OrderId,&#10;                    CustomerId = invoiceMsg.CustomerId,&#10;                    ShippingAddress = invoiceMsg.ShippingAddress,&#10;                    Lines = invoiceMsg.Lines&#10;                };&#10;&#10;                // 2. Executăm Workflow-ul (Validare -&gt; Calcul -&gt; Generare AWB)&#10;                IShipmentManifestedEvent manifestedEvent = workflow.Execute(command);&#10;&#10;                // 3. Salvăm în Baza de Date&#10;                await repository.SaveAsync(manifestedEvent);&#10;&#10;                // 4. Pregătim Mesajul de Ieșire (ShipmentManifestedMessage)&#10;                var outputMessage = new ShipmentManifestedMessage(&#10;                    OrderId: manifestedEvent.OrderId,&#10;                    CustomerId: manifestedEvent.CustomerId,&#10;                    Awb: manifestedEvent.Awb,&#10;                    ShippingAddress: manifestedEvent.ShippingAddress,&#10;                    Lines: manifestedEvent.Lines,&#10;                    ShippingCost: manifestedEvent.ShippingCost, // Aici e decimal sau Money.Amount&#10;                    DispatchedAt: manifestedEvent.ManifestedAt&#10;                );&#10;&#10;                // 5. Trimitem notificarea în lume&#10;                var body = BinaryData.FromObjectAsJson(outputMessage);&#10;                await _shippingSender.SendMessageAsync(new ServiceBusMessage(body));&#10;&#10;                // 6. Confirmăm succesul (Șterge mesajul din coadă)&#10;                await args.CompleteMessageAsync(args.Message);&#10;            }&#10;            catch (Exception ex)&#10;            {&#10;                Console.WriteLine($&quot;Eroare procesare livrare: {ex.Message}&quot;);&#10;                // Opțional: Putem trimite la DeadLetter dacă e eroare permanentă&#10;                // await args.DeadLetterMessageAsync(args.Message, &quot;ProcessingError&quot;, ex.Message);&#10;                // Sau lăsăm să se reîncerce automat (nu dăm Complete)&#10;            }&#10;        }&#10;    }&#10;&#10;    public override async Task StopAsync(CancellationToken cancellationToken)&#10;    {&#10;        await _processor.StopProcessingAsync(cancellationToken);&#10;        await _processor.DisposeAsync();&#10;        await _shippingSender.DisposeAsync();&#10;        await base.StopAsync(cancellationToken);&#10;    }&#10;}" />
              <option name="updatedContent" value="using System.Text.Json;&#10;using Azure.Messaging.ServiceBus;&#10;using Domain.Shipping.Models;&#10;using Domain.Shipping.Repositories;&#10;using Domain.Shipping.Workflows;&#10;using Microsoft.Extensions.Configuration;&#10;using Microsoft.Extensions.DependencyInjection;&#10;using Microsoft.Extensions.Hosting;&#10;using Shipping.Api.Messaging;&#10;&#10;namespace Shipping.Api;&#10;&#10;public class InvoicePaidListener : BackgroundService&#10;{&#10;    private readonly ServiceBusProcessor _processor;&#10;    private readonly ServiceBusSender _shippingSender;&#10;    private readonly IServiceProvider _serviceProvider;&#10;&#10;    public InvoicePaidListener(&#10;        ServiceBusClient client,&#10;        IConfiguration config,&#10;        IServiceProvider serviceProvider)&#10;    {&#10;        _serviceProvider = serviceProvider;&#10;&#10;        // 1. CONFIGURARE CONSUMATOR (Input)&#10;        // Ascultăm topicul unde colegul tău trimite mesajele (ex: &quot;sbt-billing-payments&quot;)&#10;        var billingTopic = config[&quot;ServiceBus:BillingTopic&quot;];&#10;        var shippingSubscription = config[&quot;ServiceBus:ShippingSubscription&quot;];&#10;        &#10;        _processor = client.CreateProcessor(billingTopic, shippingSubscription, new ServiceBusProcessorOptions&#10;        {&#10;            // Setări pentru siguranță (să nu proceseze prea multe deodată)&#10;            MaxConcurrentCalls = 1,&#10;            AutoCompleteMessages = false&#10;        });&#10;&#10;        // 2. CONFIGURARE PRODUCĂTOR (Output)&#10;        // Trimitem mesajul final către un topic nou (ex: &quot;sbt-shipping-manifests&quot;)&#10;        var shippingTopic = config[&quot;ServiceBus:ShippingTopic&quot;];&#10;        _shippingSender = client.CreateSender(shippingTopic);&#10;    }&#10;&#10;    protected override Task ExecuteAsync(CancellationToken stoppingToken)&#10;    {&#10;        _processor.ProcessMessageAsync += OnMessageAsync;&#10;        _processor.ProcessErrorAsync += args =&gt;&#10;        {&#10;            Console.WriteLine($&quot;SB ERROR: {args.Exception.GetType().Name} - {args.Exception.Message}&quot;);&#10;            return Task.CompletedTask;&#10;        };&#10;&#10;        return _processor.StartProcessingAsync(stoppingToken);&#10;    }&#10;&#10;    private async Task OnMessageAsync(ProcessMessageEventArgs args)&#10;    {&#10;        // A. Deserializare Mesaj Intrare (InvoicePaidMessage)&#10;        var bodyJson = args.Message.Body.ToString();&#10;        var invoiceMsg = JsonSerializer.Deserialize&lt;InvoicePaidMessage&gt;(bodyJson);&#10;        // SAU varianta Azure SDK: args.Message.Body.ToObjectFromJson&lt;InvoicePaidMessage&gt;();&#10;&#10;        if (invoiceMsg is null)&#10;        {&#10;            await args.DeadLetterMessageAsync(args.Message, &quot;DeserializationFailed&quot;, &quot;Body was null&quot;);&#10;            return;&#10;        }&#10;&#10;        // B. Creare Scope (Pentru servicii Scoped: DB, Workflow)&#10;        using (var scope = _serviceProvider.CreateScope())&#10;        {&#10;            var workflow = scope.ServiceProvider.GetRequiredService&lt;ShippingWorkflow&gt;();&#10;            var repository = scope.ServiceProvider.GetRequiredService&lt;IShipmentRepository&gt;();&#10;&#10;            try&#10;            {&#10;                // 1. Convertim Mesajul în Comandă Internă&#10;                var command = new ProcessShipmentCommand&#10;                {&#10;                    OrderId = invoiceMsg.OrderId,&#10;                    CustomerId = invoiceMsg.CustomerId,&#10;                    ShippingAddress = invoiceMsg.ShippingAddress,&#10;                    Lines = invoiceMsg.Lines&#10;                };&#10;&#10;                // 2. Executăm Workflow-ul (Validare -&gt; Calcul -&gt; Generare AWB)&#10;                IShipmentManifestedEvent manifestedEvent = workflow.Execute(command);&#10;&#10;                // 3. Salvăm în Baza de Date&#10;                await repository.SaveAsync(manifestedEvent);&#10;&#10;                // 4. Pregătim Mesajul de Ieșire (ShipmentManifestedMessage)&#10;                var outputMessage = new ShipmentManifestedMessage(&#10;                    OrderId: manifestedEvent.OrderId,&#10;                    CustomerId: manifestedEvent.CustomerId,&#10;                    Awb: manifestedEvent.Awb,&#10;                    ShippingAddress: manifestedEvent.ShippingAddress,&#10;                    Lines: manifestedEvent.Lines,&#10;                    ShippingCost: manifestedEvent.ShippingCost, // Aici e decimal sau Money.Amount&#10;                    DispatchedAt: manifestedEvent.ManifestedAt&#10;                );&#10;&#10;                // 5. Trimitem notificarea în lume&#10;                var body = BinaryData.FromObjectAsJson(outputMessage);&#10;                await _shippingSender.SendMessageAsync(new ServiceBusMessage(body));&#10;&#10;                // 6. Confirmăm succesul (Șterge mesajul din coadă)&#10;                await args.CompleteMessageAsync(args.Message);&#10;            }&#10;            catch (Exception ex)&#10;            {&#10;                Console.WriteLine($&quot;Eroare procesare livrare: {ex.Message}&quot;);&#10;                // Opțional: Putem trimite la DeadLetter dacă e eroare permanentă&#10;                // await args.DeadLetterMessageAsync(args.Message, &quot;ProcessingError&quot;, ex.Message);&#10;                // Sau lăsăm să se reîncerce automat (nu dăm Complete)&#10;            }&#10;        }&#10;    }&#10;&#10;    public override async Task StopAsync(CancellationToken cancellationToken)&#10;    {&#10;        await _processor.StopProcessingAsync(cancellationToken);&#10;        await _processor.DisposeAsync();&#10;        await _shippingSender.DisposeAsync();&#10;        await base.StopAsync(cancellationToken);&#10;    }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>